<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>立替編集 - TripMate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/settlement_edit.css">
</head>
<body class="bg-light">
    <%- include('partials/header', { username: username }) %>

    <main class="container-fluid py-3 py-md-5">
        <div class="row justify-content-center g-0">
            <div class="col-md-10 col-lg-8 col-xl-6">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-3 p-md-5">
                        <h2 class="h5 fw-bold mb-4 border-bottom pb-3 text-center">立替内容の編集</h2>
                        
                        <form action="/settlements/<%= settlement.id %>/update" method="POST">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">内容</label>
                                <input type="text" name="title" class="form-control form-control-lg-mobile shadow-sm" value="<%= settlement.title %>" required>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-7">
                                    <label class="form-label small fw-bold">金額</label>
                                    <input type="number" step="0.01" name="original_amount" class="form-control form-control-lg-mobile shadow-sm" value="<%= settlement.original_amount %>" required>
                                </div>
                                <div class="col-5">
                                    <label class="form-label small fw-bold">通貨</label>
                                    <input class="form-control form-control-lg-mobile shadow-sm" list="currencyOptions" name="currency" value="<%= settlement.currency %>" required>
                                    <datalist id="currencyOptions">
                                        <option value="JPY 日本円 (JPY)"></option>
                                        <option value="USD 米ドル (USD)"></option>
                                        <option value="KRW 韓国ウォン (KRW)"></option>
                                        <option value="THB タイバーツ (THB)"></option>
                                        <option value="EUR ユーロ (EUR)"></option>
                                        <option value="TWD 台湾ドル (TWD)"></option>
                                        <option value="VND ベトナムドン (VND)"></option>
                                        <option value="CNY 中国元 (CNY)"></option>
                                        <option value="GBP 英ポンド (GBP)"></option>
                                        <option value="SGD シンガポールドル (SGD)"></option>
                                        <option value="HKD 香港ドル (HKD)"></option>
                                        <option value="AUD 豪ドル (AUD)"></option>
                                        <option value="CAD カナダドル (CAD)"></option>
                                        <option value="PHP フィリピンペソ (PHP)"></option>
                                        <option value="MYR マレーシアリンギット (MYR)"></option>
                                        <option value="INR インドルピー (INR)"></option>
                                        <option value="IDR インドネシアルピア (IDR)"></option>
                                        <option value="BRL ブラジルレアル (BRL)"></option>
                                        <option value="CHF スイスフラン (CHF)"></option>
                                    </datalist>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">支払者</label>
                                <select class="form-select form-select-lg-mobile shadow-sm" name="payerId" required>
                                    <option value="<%= trip.userId %>" <%= settlement.payerId === trip.userId ? 'selected' : '' %>><%= trip.Owner.username %> (作成者)</option>
                                    <% trip.Members.forEach(member => { %>
                                        <% if(member.id !== trip.userId) { %>
                                            <option value="<%= member.id %>" <%= settlement.payerId === member.id ? 'selected' : '' %>><%= member.username %></option>
                                        <% } %>
                                    <% }) %>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label small fw-bold mb-1">対象者選択</label>
                                <select class="form-select form-select-lg-mobile mb-2 shadow-sm" name="target_type" id="targetTypeSelect">
                                    <option value="all" <%= !settlement.target_ids ? 'selected' : '' %>>全員均等</option>
                                    <option value="individual" <%= settlement.target_ids ? 'selected' : '' %>>個別指定</option>
                                </select>
                                
                                <% const savedTargetIds = settlement.target_ids ? JSON.parse(settlement.target_ids).map(String) : []; %>
                                <div id="individualSelectArea" class="p-3 border rounded shadow-inner" style="<%= settlement.target_ids ? 'display: block;' : 'display: none;' %>">
                                    <% 
                                        const memberMap = new Map();
                                        memberMap.set(trip.Owner.id, trip.Owner);
                                        trip.Members.forEach(m => memberMap.set(m.id, m));
                                        const allMembers = Array.from(memberMap.values());
                                    %>
                                    <% allMembers.forEach(m => { %>
                                        <div class="form-check py-1">
                                            <input class="form-check-input" type="checkbox" name="target_ids[]" value="<%= m.id %>" id="user<%= m.id %>"
                                            <%= savedTargetIds.includes(String(m.id)) ? 'checked' : '' %>>
                                            <label class="form-check-label ms-2" for="user<%= m.id %>"><%= m.username %></label>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>

                            <div class="d-grid gap-3 mt-5">
                                <button type="submit" class="btn btn-primary fw-bold py-3 shadow">
                                    <i class="bi bi-check-circle me-2"></i>更新を保存する
                                </button>
                                <a href="/trips/<%= trip.id %>/settlement" class="btn btn-link text-secondary text-decoration-none py-2">
                                    キャンセルして戻る
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/settlement_edit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>