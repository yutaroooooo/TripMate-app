<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精算管理 - TripMate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/settlement.css">
</head>
<body class="bg-light">
    <%- include('partials/header', { username: username }) %>

    <main class="container-fluid py-4 px-lg-5">
        <h2 class="h4 fw-bold mb-4"><%= trip.title %></h2>
    
        <div class="row g-4 align-items-start">
            
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 fixed-card-height">
                    <div class="card-body p-4 d-flex flex-column justify-content-start">
                        <h3 class="h6 fw-bold mb-3 border-bottom pb-2">新規立替入力</h3>
                        
                        <form action="/trips/<%= trip.id %>/settlement" method="POST">
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">支払者選択</label>
                                <select class="form-select form-select-sm shadow-sm" name="payerId" required>
                                    <option value="<%= trip.userId %>"><%= trip.Owner.username %> (作成者)</option>
                                    <% trip.Members.forEach(member => { %>
                                        <% if(member.id !== trip.userId) { %>
                                            <option value="<%= member.id %>"><%= member.username %></option>
                                        <% } %>
                                    <% }) %>
                                </select>
                            </div>
    
                            <div class="mb-3">
                                <label class="form-label small fw-bold mb-1">対象者選択</label>
                                <select class="form-select form-select-sm shadow-sm mb-2" name="target_type" id="targetTypeSelect">
                                    <option value="all">全員均等</option>
                                    <option value="individual">個別指定</option>
                                </select>
                                
                                <div id="individualSelectArea" class="p-2 border rounded bg-light" style="display: none; max-height: 100px; overflow-y: auto;">
                                    <% members.forEach(m => { %>
                                        <div class="form-check small">
                                            <input class="form-check-input" type="checkbox" name="target_ids[]" value="<%= m.id %>" id="user<%= m.id %>">
                                            <label class="form-check-label" for="user<%= m.id %>"><%= m.username %></label>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
    
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">内容 & 金額入力</label>
                                <input type="text" name="title" class="form-control form-control-sm shadow-sm mb-2" placeholder="例：レンタカー代" required>
                                <div class="row g-1">
                                    <div class="col-7">
                                        <input type="number" step="0.01" name="original_amount" class="form-control form-control-sm shadow-sm" placeholder="例：1000" required>
                                    </div>
                                    <div class="col-5">
                                        <input class="form-control form-control-sm shadow-sm" list="currencyOptions" name="currency" placeholder="通貨検索" required>
                                        <datalist id="currencyOptions">
                                            <option value="JPY 日本円 (JPY)"></option>
                                            <option value="USD 米ドル (USD)"></option>
                                            <option value="KRW 韓国ウォン (KRW)"></option>
                                            <option value="THB タイバーツ (THB)"></option>
                                            <option value="EUR ユーロ (EUR)"></option>
                                            <option value="TWD 台湾ドル (TWD)"></option>
                                            <option value="VND ベトナムドン (VND)"></option>
                                            <option value="CNY 中国元 (CNY)"></option>
                                            <option value="GBP 英ポンド (GBP)"></option>
                                            <option value="SGD シンガポールドル (SGD)"></option>
                                            <option value="HKD 香港ドル (HKD)"></option>
                                            <option value="AUD 豪ドル (AUD)"></option>
                                            <option value="CAD カナダドル (CAD)"></option>
                                            <option value="PHP フィリピンペソ (PHP)"></option>
                                            <option value="MYR マレーシアリンギット (MYR)"></option>
                                            <option value="INR インドルピー (INR)"></option>
                                            <option value="IDR インドネシアルピア (IDR)"></option>
                                            <option value="BRL ブラジルレアル (BRL)"></option>
                                            <option value="CHF スイスフラン (CHF)"></option>
                                        </datalist>
                                    </div>
                                </div>
                            </div>
    
                            <div class="mb-3">
                                <label class="form-label small fw-bold mb-1">明細入力欄</label>
                                <textarea class="form-control form-control-sm shadow-sm" id="detailInput" name="raw_text" rows="2" placeholder="予約メール等を貼り付けて&#10;AI明細解析ボタンをタップ"></textarea>
                            </div>
    
                            <div class="d-grid gap-2 mt-4"> 
                            <button type="button" class="btn btn-outline-info btn-sm fw-bold py-2 shadow-sm" id="analyzeBtn">
                                <i class="bi bi-magic me-1"></i>AI明細解析
                            </button>
                            
                            <button type="submit" class="btn btn-primary btn-sm fw-bold py-2 shadow">
                                <i class="bi bi-save me-1"></i>登録する
                            </button>
                        
                            <button type="button" class="btn btn-outline-success btn-sm fw-bold py-2 shadow-sm" id="remindBtn">
                                <i class="bi bi-line me-1"></i>精算リマインド
                            </button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
    
            <div class="col-lg-4">
                <div class="card shadow-sm border-0" style="height: 550px;">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h3 class="h6 fw-bold mb-0">立替履歴リスト</h3>
                    </div>
                    <div class="card-body p-0" style="height: 500px; overflow-y: auto;">
                        <div class="list-group list-group-flush" id="historyList">
                            <% if (settlements && settlements.length > 0) { %>
                                <% settlements.forEach(item => { %>
                                    <div class="list-group-item p-3">
                                        <div class="small text-muted mb-1" style="font-size: 0.65rem;">
                                            <i class="bi bi-clock me-1"></i>
                                            <% if (item.created_at) { %>
                                                <%= new Date(item.created_at).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) %>
                                            <% } else if (item.createdAt) { %>
                                                <%= new Date(item.createdAt).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) %>
                                            <% } %>
                                        </div>
                        
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <span class="fw-bold"><%= item.title %></span>
                                            <div class="text-end">
                                                <div class="fw-bold text-primary">¥<%= item.amount.toLocaleString() %></div>
                                                <% if (item.currency !== 'JPY') { %>
                                                    <div class="small text-muted" style="font-size: 0.7rem;">
                                                        (<%= item.original_amount.toLocaleString() %> <%= item.currency %>)
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                        
                                        <div class="mb-3">
                                            <div class="d-flex flex-wrap gap-1">
                                                <span class="badge bg-white text-muted fw-normal border" style="font-size: 0.7rem;">
                                                    <i class="bi bi-person-fill me-1 text-primary"></i>支払: <%= item.Payer.username %>
                                                </span>
                                                <span class="badge bg-white text-muted fw-normal border" style="font-size: 0.7rem;">
                                                    <i class="bi bi-people-fill me-1 text-success"></i>対象: 
                                                    <% if (item.target_ids) { %>
                                                        <%
                                                            const targetIds = JSON.parse(item.target_ids);
                                                            const targetNames = members
                                                                .filter(m => targetIds.includes(String(m.id)) || targetIds.includes(Number(m.id)))
                                                                .map(m => m.username);
                                                        %>
                                                        <%= targetNames.join('、') %>
                                                    <% } else { %>
                                                        全員
                                                    <% } %>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a href="/settlements/<%= item.id %>/edit" class="btn btn-sm btn-outline-secondary py-1 px-3 rounded-pill" style="font-size: 0.75rem;">編集</a>
                                            <form action="/settlements/<%= item.id %>/delete" method="POST" style="display: inline;">
                                                <button type="button" class="btn btn-sm btn-outline-danger py-1 px-3 rounded-pill" 
                                                style="font-size: 0.75rem;" 
                                                onclick="confirmDelete('<%= item.id %>')">削除</button>
                                            </form>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <div class="text-center py-5 text-muted">立替履歴はありません</div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="col-lg-4" style="height: 550px;">
                <div class="card shadow-sm border-0 bg-dark text-white overflow-hidden" style="min-height: 555px;">
                    <div style="height: 6px; background: linear-gradient(90deg, #66ccff, #3399ff);"></div>
                    <div class="card-body text-center d-flex flex-column justify-content-center p-4">
                        <h3 class="h6 fw-bold mb-4 text-uppercase tracking-wider text-info">精算サマリー</h3>
                        
                        <div class="summary-box p-4 border border-secondary rounded-4 mb-4" style="background: rgba(255,255,255,0.05);">
                            <p class="small text-secondary mb-3">貸し借りを相殺した最終結果</p>
                            
                            <% if (summaries && summaries.length > 0) { %>
                                <div class="scroll-internal" style="height: auto; max-height: 250px;">
                                    <% summaries.forEach(s => { %>
                                        <div class="mb-3">
                                            <div class="h6 mb-1 text-warning fw-bold">
                                                <%= s.from %> <i class="bi bi-arrow-right mx-1"></i> <%= s.to %>
                                            </div>
                                            <div class="h4 fw-bold mb-0 text-white">
                                                ¥<%= s.total.toLocaleString() %>
                                            </div>
                                        </div>
                                        <hr class="border-secondary opacity-25">
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div class="text-muted small py-4">貸し借りは現在ありません</div>
                            <% } %>
                        </div>
                        
                        <div class="mt-2 small text-secondary">
                            <i class="bi bi-info-circle me-1"></i>
                            「誰が誰にいくら」を表示します
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/settlement.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>